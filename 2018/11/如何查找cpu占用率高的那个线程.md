背景
---

运维同学发来消息，我们的一个服务异常，cpu使用率飙升至99%。

![cpu99%](https://lemontree863.github.io/2018/11/cpu99.png)

分析
---
看到cpu是在晚上8点之后，忽然就飙升至99%，询问了相关同学，在这个点有没有做一些操作，但都表示没有特殊操作，只是做了一些数据库的操作，应该不会引起cpu飙升。

那只能去服务器上查看是由哪个线程导致的cpu利用率那么高。

首先，使用top命令找到cpu使用率最高的进程，默认是按照cpu使用率从高到低排序
```
top
```
比如，parent_id=12849

然后，找到该进程下cpu使用率最高的线程


```
top -Hp 12849
```

通过查看输出，并没有看到cpu占用率特别高的线程，都是比较平均的。所有，随机抽取了几个线程id，看看到底是在执行什么代码。

比如，child_id=14592

接着，使用jstack命令打印cpu使用率高的进程的堆栈信息
```
jstack parent_id > tmp.out
```

在tmp.out中查找对应线程堆栈信息，通过 printf %0x [child_id]得到线程的十六机制数值，再搜索。这样，我们就能看到此线程对应的代码行数。




